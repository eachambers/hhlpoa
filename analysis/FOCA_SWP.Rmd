---
title: "FOCA Source Water Protection Plan"
output:
  github_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(cowplot)
library(lubridate)
library(grid)
library(gridExtra)
library(tidyterra)
library(MetBrewer)
theme_set(theme_cowplot())

source(here("analysis", "functions.R"))

# Import colors, specify names, etc.
lake_cols_raw <- lake_colors(raw_data = TRUE)
data_cols_warms <- data_colors(type = "warms")
data_cols <- data_colors(type = "assorted")
lake_col_full <- lake_colors(full_names = TRUE)
```

## Figure 3A: Water supply survey results

```{r}
# Import data
sw <- read_tsv(here("data", "source_water_results.txt"))
sw$Category <- factor(sw$Category, levels = c("Surface water", "Well", "Municipal water source", "Water from elsewhere", "Spring"))

sw %>% 
  ggplot(aes(fill = Category, y = Percentage, x = Lake)) + 
    geom_bar(position = "stack", stat = "identity") +
    geom_text(aes(label = Percentage), size = 3, vjust = 3, position = "stack") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = met.brewer("Nizami", n = 5)) + # Renoir is also good
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  ylab("Percentage (%)")

# Save plot in "plots" directory
ggsave(here("plots", "fig3a_sourcewater.pdf"), width = 5, height = 5)
```

## Figure 5: Depths of wells

```{r}
# Import the data
wd <- read_tsv(here("data", "source_water_welldepth.txt"))
```

Build plot:

```{r}
wd %>% 
  ggplot(aes(x = `Well depth (feet)`)) +
  geom_histogram() +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  coord_flip() +
  ylab("Number of wells")

# Save plot in "plots" directory
ggsave(here("plots", "fig5_welldepth.pdf"), width = 3, height = 5)
```

## Figure 6: Threats from TSW

Look at lake levels for 2024.

```{r}
levels <- read_tsv(here("data", "lake_levels.txt"))
levels$Date <- lubridate::mdy(levels$Date)
levels <- levels %>% 
  mutate("Year" = year(Date),
         "DOY" = yday(Date))
# There's only a single observation for 2010 for Hawk Lake so we'll remove it
levels <- levels %>% 
  filter(!(Year == 2010 & Lake == "Hawk"))

# Calculate monthly min, max, and average across all years
summary <- levels %>% 
  group_by(Lake, DOY) %>% 
  summarize(Average = mean(`Water level (m)`),
            Maximum = max(`Water level (m)`),
            Minimum = min(`Water level (m)`))

doy_months <- read_tsv(here("data", "DOY_months.txt"))
```

Build the plot for 2024 for Halls Lake Dam.

```{r}
ggplot() +
  # Add month bars
  geom_rect(data = doy_months %>% 
              filter(Month %in% c("Jan", "Mar", "May", "Jul", "Sep", "Nov")), 
            aes(xmin = Start, xmax = End, 
                ymin = 1.25, ymax = 3.1),
            fill = "grey", alpha = 0.5) +
  # Add min and max levels
  geom_ribbon(data = summary %>% 
                filter(Lake == "Halls"),
              aes(x = DOY, ymin = Minimum, ymax = Maximum), 
              fill = "dodgerblue1", alpha = 0.5) +
  # Add average over all years
  geom_line(data = summary %>% 
              filter(Lake == "Halls"),
            aes(x = DOY, y = Average), 
            color = "dodgerblue1", linetype = "dashed", linewidth = 1) +
  # Add 2024 data only
  geom_line(data = levels %>% 
              filter(Year == 2024) %>% 
              filter(Lake == "Halls"), 
            aes(x = DOY, y = `Water level (m)`, group = Lake, color = Lake), 
            linewidth = 1) +
  ylab("Water level (m)") +
  xlab("Day of the Year") +
  theme(panel.grid.major.y = element_line(linewidth = 0.5, linetype = "dashed", color = "grey")) +
  # ggtitle("Lake levels at Halls Lake Dam (2024)") +
  theme(legend.position = "none") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0))

# Save plot
ggsave(here("plots", "source_water_levels_halls.pdf"), width = 10, height = 6)
```


What time of year do min/max occur?

```{r}
min_time_of_year <- 
  levels %>% 
  mutate(Month = month(Date)) %>% 
  group_by(Lake, Year) %>% 
  filter(`Water level (m)` == min(`Water level (m)`)) %>% 
  dplyr::select(Lake, Year, Month) %>% 
  distinct()
max_time_of_year <- 
  levels %>% 
  mutate(Month = month(Date)) %>% 
  group_by(Lake, Year) %>% 
  filter(`Water level (m)` == max(`Water level (m)`)) %>% 
  dplyr::select(Lake, Year, Month) %>% 
  distinct()

min_time_of_year %>% 
  ggplot(aes(x = Month)) +
  geom_bar(stat = "count", aes(fill = Lake)) +
  # scale_fill_manual(values = c("#448cbc", "#58ae50"))
  facet_grid(~Lake) +
  scale_x_continuous(breaks = 1:12)

max_time_of_year %>% 
  ggplot(aes(x = Month)) +
  geom_bar(stat = "count", aes(fill = Lake)) +
  # scale_fill_manual(values = c("#448cbc", "#58ae50"))
  facet_grid(~Lake) +
  scale_x_continuous(breaks = 1:12)
```

### Fluctuations

Amount of annual fluctuation is the maximum lake level minus the minimum lake level. Calculate fluctuations using the levels data for each year:

```{r}
fluct <- levels %>% 
  ungroup() %>% 
  group_by(Lake, Year) %>% 
  summarize(minimum = min(`Water level (m)`),
            maximum = max(`Water level (m)`),
            fluctuation = maximum-minimum)

# Year with max fluctuation in Halls Lake?
fluct %>% 
  filter(Lake == "Halls") %>% 
  summarize(max(fluctuation))
```

Plot the data:

```{r}
fluct$Year <- as.character(fluct$Year)

# Plot the range of values:
fluct %>% 
  filter(Lake == "Halls") %>% 
  ggplot() +
  # geom_segment(aes(x = Year, xend = Year, y = minimum, yend = maximum, color = Lake), 
  #              linewidth = 10, alpha = 0.75) +
  geom_line(aes(x = Year, y = fluctuation, group = 1), color = "black") +
  geom_point(aes(x = Year, y = fluctuation), pch = 21, size = 4, 
             color = "black", fill = "white") +
  # scale_x_continuous(breaks = 2013:2024) +
  # ylab("Lake level (m)") +
  ylab("Annual water level \nfluctuation (m)") +
  # ggtitle("Halls Lake fluctuations (2013-2024)") +
  scale_color_manual(values = "#448cbc") +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text = element_text(size = 14),
        panel.grid.major.y = element_line(linewidth = 0.5, linetype = "dashed", color = "grey"),
        axis.text.x = element_text(angle = 45, hjust = 1))

# Save plot
ggsave(here("plots", "source_water_fluct.pdf"), width = 12, height = 4)
```

## Figure 9: Protections afforded by buffer

```{r}
prot <- read_tsv(here("data", "wells_protected.txt"))
prot %>% 
  ggplot(aes(x = `Buffer (m)`, y = `Wells protected`)) +
  geom_point() +
  geom_line() +
  ylab("Number of wells protected")

prot %>% 
  ggplot(aes(x = `Buffer (m)`, y = `Prop wells protected at 500m`)) +
  geom_point() +
  geom_line() +
  ylab("Proportion of wells protected \nrelative to 500m boundary (%)") +
  scale_y_continuous(limits = c(0, 100)) +
  geom_hline(yintercept = 100, linetype = "dashed", color = "limegreen")
```

# DATA ANALYSIS

## Physical indicators

Import and tidy data.

```{r}
secchi_dat <- read_tsv(here("data", "FOCA_Secchi.txt"))
secchi_dat$Date <- lubridate::mdy(secchi_dat$Date)
secchi_dat <- secchi_dat %>% 
  mutate("Year" = year(Date))

pca <- read_tsv(here("data", "FOCA_PCa.txt"))
pca$Date <- lubridate::dmy(pca$Date)
pca <- pca %>% mutate("Year" = year(Date))

# read_tsv(here("data", "FOCA_DOTemp.txt")) %>% 
#   pivot_longer(cols = 2:15, names_to = "metadata", values_to = "value") %>% write_tsv(here("data", "FOCA_newDOTemp.txt"))
#   separate(metadata, into = c("date", "tmp", "tmp2", "statistic"), sep = "_")

dotemp <- read_tsv(here("data", "FOCA_newDOTemp.txt"))
dotemp$Date <- lubridate::mdy(dotemp$Date)
dotemp <- dotemp %>% 
  mutate("Year" = year(Date),
         "Month" = month(Date))

# Divide into summer and fall
dotemp <- dotemp %>% mutate(season = case_when(Month == 6 | Month == 7 ~ "summer",
                                     Month == 9 | Month == 10 ~ "fall"))
```

### Phosphorus and calcium

```{r}
p_phos <-
  pca %>% 
  ggplot(aes(x = Year, y = `Average Total Phosphorus (µg/L)`)) +
    geom_smooth(method = "lm", se = FALSE, color = "grey45", aes(group = 1)) +
  geom_point(aes(group = Year), size = 3, color = "coral") +
  theme(legend.position = "none",
        strip.text = element_text(size = 16),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  scale_x_continuous(breaks = scales::breaks_width(1)) +
  scale_y_continuous(limits = c(0, 10), breaks = 0:10) +
  # ggtitle("Phosphorus levels (2002-2022)") +
  ylab("Total phosphorus (µg/L)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = 10, color = "darkred", linetype = "dashed") # coeff = 0.003902, not sig

p_ca <- 
  pca %>% 
  # na.omit() %>% 
  ggplot(aes(x = Year, y = `Calcium (mg/L)`)) +
    geom_smooth(method = "lm", se = FALSE, color = "grey45", aes(group = 1)) +
  geom_point(aes(group = Year), color = "orange", size = 3) +
  theme(legend.position = "none",
        strip.text = element_text(size = 16),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  scale_x_continuous(breaks = scales::breaks_width(1)) +
  scale_y_continuous(limits = c(0, 3), breaks = 0:10) +
  # ggtitle("Calcium levels (2010-2022)") +
  geom_hline(yintercept = 1.5, color = "darkred", linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Calcium (mg/L)") # coeff = 9.838e-04, not sig

plot_grid(p_phos, p_ca, nrow = 2)

ggsave(here("plots", "FOCA_PCa.pdf"), width = 5, height = 5)
```

### Water clarity (Secchi depth)

```{r}
p_secchi <-
  secchi_dat %>% 
  ggplot(aes(x = Year, y = `Secchi Depth (metres)`)) +
    geom_smooth(method = "lm", se = FALSE, color = "grey45", aes(group = 1)) +
  geom_boxplot(aes(group = Year), color = "cornflowerblue", alpha = 0.5) +
  theme(legend.position = "none",
        strip.text = element_text(size = 16),
        strip.background = element_blank()) +
  scale_x_continuous(breaks = scales::breaks_width(5)) +
  scale_y_continuous(limits = c(0, 11), breaks = 0:11) +
  ggtitle("Water transparency (1991-2022)") +
  ylab("Secchi depth (m)")

# Save plot in "plots" directory
p_secchi
ggsave(here("plots", "FOCA_secchi.pdf"), width = 8, height = 4)
```

### Dissolved oxygen and temperature

```{r}
dotemp %>% 
  filter(Month == 7) %>%
  pivot_wider(names_from = Statistic,  values_from = Value) %>% 
  ggplot(aes(x = Depth, y = Temp, group = Year)) +
  geom_point(aes(color = Year)) +
  geom_line(aes(color = Year)) +
  coord_flip()
  # facet_grid(~season) +
  # scale_color_continuous(breaks = seq(2022, 2025, 1))
```